<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>莲塘社康中医体质辨识</title>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="xlsx.full.min.js"></script>
    <style>
        /* 全局样式 */
        :root {
            /* 现代化中医配色方案 */
            --primary-color: #9C6644; /* 温暖棕色调 */
            --secondary-color: #7F5539; /* 深棕色 */
            --accent-color: #4A7C59; /* 沉稳绿色 */
            --accent-hover: #3D6649; /* 深绿色 */
            --neutral-color: #F8F4E9; /* 柔和米色背景 */
            --card-bg: #FFFFFF; /* 纯白色卡片背景 */
            --text-primary: #2D3748; /* 深灰色文字 */
            --text-secondary: #718096; /* 浅灰色文字 */
            --border-color: #E2D6C2; /* 柔和边框色 */
            --success-color: #38A169; /* 现代成功色 */
            --warning-color: #D69E2E; /* 现代警告色 */
            --danger-color: #E53E3E; /* 现代危险色 */
            --info-color: #3182CE; /* 现代信息色 */
            
            /* 阴影效果 */
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.12);
            --shadow-large: 0 8px 32px rgba(0, 0, 0, 0.16);
            --shadow-inset: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            
            /* 间距 */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 48px;
            
            /* 圆角 */
            --border-radius-sm: 6px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
            --border-radius-full: 50px;
            
            /* 过渡动画 */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Noto Serif SC", "Microsoft YaHei", "PingFang SC", sans-serif; /* 现代化中文字体 */
            line-height: 1.7;
            color: var(--text-primary);
            background-color: var(--neutral-color);
            padding: 0;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23E2D6C2' fill-opacity='0.15' fill-rule='evenodd'/%3E%3C/svg%3E");
            background-attachment: fixed;
            background-size: cover;
        }

        /* 平滑滚动 */
        html {
            scroll-behavior: smooth;
        }

        /* 全局过渡效果 */
        * {
            transition: all var(--transition-normal);
        }

        /* 选择文本样式 */
        ::selection {
            background-color: rgba(156, 102, 68, 0.15);
            color: var(--primary-color);
        }

        .page-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1500px;
            width: 100%;
            margin: 0 auto;
            padding: var(--spacing-md);
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--spacing-lg);
            flex: 1;
        }

        header {
            text-align: center;
            padding: var(--spacing-xl) var(--spacing-md);
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            margin: var(--spacing-md);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color), var(--primary-color));
        }

        header h1 {
            color: var(--primary-color);
            margin-bottom: var(--spacing-sm);
            font-size: 32px;
            font-weight: 700;
            letter-spacing: 1px;
        }

        header p {
            color: var(--text-secondary);
            font-size: 16px;
            max-width: 800px;
            margin: 0 auto;
        }

        main, aside {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            padding: var(--spacing-xl);
            transition: all 0.3s ease;
        }

        main:hover, aside:hover {
            box-shadow: var(--shadow-medium);
        }

        /* 主内容区滚动容器 */
        .main-content {
            overflow-y: auto;
            max-height: calc(100vh - 220px); /* 减去头部和底部空间 */
            padding-right: var(--spacing-sm); /* 为滚动条预留空间 */
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--neutral-color);
        }

        .main-content::-webkit-scrollbar {
            width: 8px;
        }

        .main-content::-webkit-scrollbar-track {
            background: var(--neutral-color);
            border-radius: 10px;
        }

        .main-content::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 10px;
        }

        /* 侧边栏内容区 */
        .sidebar-wrapper {
            position: sticky;
            top: 20px; /* 距离顶部的距离 */
            max-height: calc(100vh - 40px); /* 减去上下边距 */
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }

        .constitution-rules {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
            overflow-y: auto;
            padding-right: var(--spacing-sm);
            max-height: 40%;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--neutral-color);
        }

        .constitution-rules::-webkit-scrollbar {
            width: 6px;
        }

        .constitution-rules::-webkit-scrollbar-track {
            background: var(--neutral-color);
            border-radius: 10px;
        }

        .constitution-rules::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 10px;
        }

        footer {
            text-align: center;
            padding: var(--spacing-md) 0;
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: auto;
            background-color: var(--card-bg);
            border-top: 1px solid var(--border-color);
        }

        /* 通用组件样式 */
        .section-title {
            color: var(--primary-color);
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--primary-color);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 22px;
            font-weight: 600;
        }

        /* 卡片样式 */
        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-light);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            transition: all var(--transition-normal);
            border: 1px solid var(--border-color);
            position: relative;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            transform: scaleX(0);
            transition: transform var(--transition-normal);
        }

        .card:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-3px);
            border-color: var(--primary-color);
        }

        .card:hover::before {
            transform: scaleX(1);
        }

        /* 中医四诊信息样式 */
        .diagnosis-container {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: var(--card-bg);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-medium);
            margin: 0 var(--spacing-md) var(--spacing-lg);
            padding: var(--spacing-lg);
            transition: all var(--transition-normal);
            border: 1px solid var(--border-color);
        }

        .diagnosis-form {
            margin-bottom: 0;
        }

        /* 四诊信息布局 */
        .diagnosis-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px 20px; /* 合理间距 */
        }

        /* 四诊信息的表单组 */
        .diagnosis-grid .form-group {
            display: flex;
            align-items: center; /* 垂直居中对齐 */
            gap: 10px; /* 标签与输入框的距离近一些 */
            margin-bottom: 0;
            width: 100%;
        }

        /* 标签样式 */
        .diagnosis-grid .form-group label {
            width: auto;
            min-width: 50px; /* 确保标签文字不被截断 */
            font-weight: 600;
            color: var(--text-primary);
            padding-top: 0;
            flex-shrink: 0; /* 防止标签被压缩消失 */
            text-align: right; /* 对齐更美观 */
        }

        /* 输入框容器 - 确保不挤压标签 */
        .diagnosis-grid .multi-select-container {
            flex: 1;
            min-width: 0; /* 允许适当收缩 */
        }

        /* 可编辑下拉框样式 */
        .editable-select {
            position: relative;
            flex: 1;
        }
        
        .editable-select input {
            width: 100%; /* 输入框宽度适中 */
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .editable-select input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* 多选下拉框样式 */
        .multi-select-container {
            position: relative;
            flex: 1;
        }
        
        .multi-select-input {
            width: 100%; /* 输入框宽度适中 */
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 13px;
            transition: border-color 0.3s ease;
        }
        
        .multi-select-input::placeholder {
            font-size: 12px;
            color: #999;
        }
        
        .multi-select-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 5px;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }
        
        .multi-select-dropdown.active {
            display: block;
        }
        
        .multi-select-option {
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .multi-select-option:hover {
            background-color: var(--neutral-color);
        }
        
        .multi-select-option.selected {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--primary-color);
        }
        
        /* 下拉框箭头 */
        .select-arrow {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--text-secondary);
            display: none;
        }
        
        .multi-select-container:hover .select-arrow,
        .multi-select-input:focus + .select-arrow {
            display: block;
        }
        
        .select-hint {
            display: none;
        }

        /* BMI计算器样式 */
        .bmi-calculator {
            margin-bottom: var(--spacing-xl);
        }

        .form-group {
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-md);
        }

        .form-group label {
            width: 110px;
            font-weight: 600;
            color: var(--text-primary);
            padding-top: 10px;
        }

        /* 表单元素样式 */
        .form-group select,
        .form-group input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-md);
            font-size: 16px;
            transition: all var(--transition-normal);
            background-color: white;
            box-shadow: var(--shadow-inset);
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(156, 102, 68, 0.1);
            transform: translateY(-1px);
        }

        .form-group select:hover,
        .form-group input:hover {
            border-color: var(--primary-color);
        }

        /* 输入框占位符样式 */
        .form-group input::placeholder {
            color: var(--text-secondary);
            font-style: italic;
        }

        /* 输入框聚焦状态 */
        .form-group input:focus::placeholder {
            color: transparent;
        }

        .unit {
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .bmi-result {
            margin: var(--spacing-lg) 0;
            padding: var(--spacing-md);
            background-color: rgba(52, 152, 219, 0.1);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
        }

        .bmi-result p {
            margin: 5px 0;
            font-size: 16px;
        }

        #bmiValue {
            font-weight: bold;
            color: var(--primary-color);
        }

        .underweight { color: var(--info-color); font-weight: bold; }
        .normal { color: var(--success-color); font-weight: bold; }
        .overweight { color: var(--warning-color); font-weight: bold; }
        .obese { color: var(--danger-color); font-weight: bold; }

        .bmi-standard {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background-color: #f8f8f8;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .bmi-standard h3 {
            margin-bottom: var(--spacing-sm);
            font-size: 16px;
            color: var(--text-primary);
        }

        .bmi-standard ul {
            padding-left: 20px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* 问卷样式 */
        .questions-section {
            margin-bottom: var(--spacing-xl);
        }

        .instructions {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-lg);
            font-style: italic;
            padding: var(--spacing-md);
            background-color: #f8f8f8;
            border-radius: var(--border-radius);
        }

        .questions-container {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }

        /* 问题卡片样式 */
        .question-item {
            background-color: var(--card-bg);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-lg);
            border: 1px solid var(--border-color);
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-light);
            position: relative;
            overflow: hidden;
        }

        .question-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            transform: scaleX(0);
            transition: transform var(--transition-normal);
        }

        .question-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
            border-color: var(--primary-color);
        }

        .question-item:hover::before {
            transform: scaleX(1);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }

        .question-header h3 {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
        }

        .related-constitutions {
            font-size: 13px;
            color: var(--primary-color);
            background-color: rgba(156, 102, 68, 0.1);
            padding: 4px 10px;
            border-radius: var(--border-radius-full);
            white-space: nowrap;
            font-weight: 500;
        }

        .question-text {
            margin-bottom: var(--spacing-md);
            line-height: 1.8;
            color: var(--text-primary);
            font-size: 15px;
        }

        /* 选项横向排列 */
        .question-options {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }

        /* 选项样式 */
        .option-item {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            border-radius: var(--border-radius-md);
            transition: all var(--transition-normal);
            border: 2px solid transparent;
            white-space: nowrap;
            background-color: #F7FAFC;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .option-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(156, 102, 68, 0.1), transparent);
            transition: left var(--transition-fast);
        }

        .option-item:hover {
            background-color: #EDF2F7;
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }

        .option-item:hover::before {
            left: 100%;
        }

        /* 选中选项样式 */
        .option-item input[type="radio"]:checked + label {
            font-weight: 600;
            color: var(--primary-color);
        }

        .option-item input[type="radio"]:checked + label::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200%;
            height: 200%;
            background: rgba(156, 102, 68, 0.05);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            animation: ripple 0.6s ease-out;
            z-index: 0;
        }

        /* 选项输入框样式 */
        .option-item input {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary-color);
            transition: transform var(--transition-fast);
            z-index: 1;
        }

        .option-item input:hover {
            transform: scale(1.2);
        }

        .option-item label {
            cursor: pointer;
            font-size: 14px;
            color: var(--text-primary);
            position: relative;
            z-index: 1;
        }

        /* 波纹动画 */
        @keyframes ripple {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0;
            }
        }

        /* 提交按钮和文件名区域 */
        .submit-section {
            text-align: center;
            margin: var(--spacing-xl) 0 var(--spacing-md);
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
        }

        .filename-group {
            margin-bottom: var(--spacing-lg);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        .filename-group label {
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
        }

        .filename-group input {
            width: 300px;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .filename-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .file-extension {
            color: var(--text-secondary);
            font-style: italic;
        }

        /* 按钮样式 */
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: all var(--transition-normal);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-light);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left var(--transition-slow);
        }

        .btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow-inset);
        }

        .btn:focus {
            outline: 2px solid rgba(156, 102, 68, 0.3);
            outline-offset: 2px;
        }

        /* 主要按钮 */
        .btn-primary {
            background-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        /* 次要按钮 */
        .btn-secondary {
            background-color: #F7FAFC;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: #EDF2F7;
            border-color: var(--primary-color);
        }

        /* 成功按钮 */
        .btn-success {
            background-color: var(--accent-color);
        }

        .btn-success:hover {
            background-color: var(--accent-hover);
        }

        #submitBtn, #resetBtn, #calculateBmiBtn {
            margin: 0 8px;
        }

        /* 侧边栏规则说明 */
        .constitution-rules h2 {
            font-size: 18px;
            margin-bottom: var(--spacing-md);
            color: var(--primary-color);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .constitution-rules ul {
            padding-left: 20px;
            margin-bottom: 0;
            color: var(--text-secondary);
        }

        .constitution-rules li {
            margin-bottom: 8px;
            line-height: 1.7;
        }

        .constitution-questions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .constitution-item {
            font-size: 14px;
            padding: 6px 0;
            border-bottom: 1px dashed var(--border-color);
            color: var(--text-secondary);
        }

        .constitution-item strong {
            color: var(--text-primary);
        }

        /* 体质关联题目链接样式 */
        .question-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            padding: 2px 6px;
            border-radius: var(--border-radius-sm);
            transition: all var(--transition-fast);
            position: relative;
        }

        .question-link:hover {
            color: var(--secondary-color);
            background-color: rgba(156, 102, 68, 0.1);
            text-decoration: underline;
            transform: translateY(-1px);
            box-shadow: var(--shadow-light);
        }

        .question-link:active {
            transform: translateY(0);
            box-shadow: var(--shadow-inset);
        }

        /* 平滑滚动效果 */
        html {
            scroll-behavior: smooth;
        }

        /* 滚动到锚点时的偏移量，避免被顶部固定元素遮挡 */
        :target {
            scroll-margin-top: 100px;
        }

        /* 结果区域 - 固定位置 */
        .results-section {
            background-color: #f8f8f8;
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            max-height: 60%;
        }

        .results-section h2 {
            margin-bottom: var(--spacing-md);
            font-size: 18px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .result-table-container {
            max-height: 200px; /* 表格高度限制 */
            overflow-y: auto;
            margin-bottom: var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
        }

        /* 表格样式 */
        .result-table {
            width: 100%;
            border-collapse: collapse;
            min-height: 100%;
            background-color: white;
            border-radius: var(--border-radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-inset);
        }

        .result-table th, .result-table td {
            border-bottom: 1px solid var(--border-color);
            padding: 10px 12px;
            text-align: center;
            font-size: 14px;
            transition: all var(--transition-fast);
        }

        .result-table th {
            background-color: rgba(156, 102, 68, 0.1);
            color: var(--primary-color);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
            text-transform: uppercase;
            font-size: 13px;
            letter-spacing: 0.5px;
        }

        .result-table tr:last-child td {
            border-bottom: none;
        }

        .result-table tr:nth-child(even) {
            background-color: rgba(156, 102, 68, 0.02);
        }

        .result-table tr:hover {
            background-color: rgba(156, 102, 68, 0.05);
        }

        .result-table td {
            color: var(--text-primary);
        }

        .result-table td:first-child {
            font-weight: 500;
        }

        .summary {
            background-color: rgba(52, 152, 219, 0.1);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
            font-size: 14px;
            line-height: 1.6;
            border-left: 3px solid var(--primary-color);
            flex-shrink: 0;
        }

        /* 响应式设计 */
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto;
            }
            
            .sidebar-wrapper {
                position: static;
                max-height: none;
            }
            
            .constitution-rules, .results-section {
                max-height: none;
            }
            
            .main-content {
                max-height: none;
            }
        }

        @media (max-width: 768px) {
            .diagnosis-grid {
                grid-template-columns: 1fr;
            }
            
            .question-header {
                flex-direction: column;
                gap: var(--spacing-sm);
            }
            
            .related-constitutions {
                align-self: flex-start;
            }
            
            /* 小屏幕下选项恢复垂直排列 */
            .question-options {
                flex-direction: column;
                gap: var(--spacing-sm);
            }
            
            .filename-group {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .filename-group input {
                width: 100%;
            }
            
            .form-group {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .form-group label {
                width: 100%;
                margin-bottom: 5px;
                padding-top: 0;
            }
            
            #submitBtn, #resetBtn {
                width: 100%;
                margin: 5px 0;
            }
            
            main, aside {
                padding: var(--spacing-md);
            }
            
            .result-table-container {
                max-height: 180px;
            }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <header>
            <h1>莲塘社康中医体质辨识</h1>
            <p>通过专业问卷评估您的体质类型，提供个性化健康参考建议</p>
        </header>
        
        <div class="container">
            <main>
                <!-- 中医四诊信息区域 - 冻结窗口效果 -->
                <div class="diagnosis-container">
                    <section class="diagnosis-form card">
                        <h2 class="section-title">
                            <i class="fa fa-stethoscope" aria-hidden="true"></i> 中医四诊信息
                        </h2>
                        
                        <div class="diagnosis-grid">
                            <!-- 望 - 下拉多选框+输入框 -->
                            <div class="form-group">
                                <label for="wang">望:</label>
                                <div class="multi-select-container">
                                    <input type="text" id="wang" class="multi-select-input" placeholder="请选择或输入...">
                                    <i class="fa fa-chevron-down select-arrow"></i>
                                    <div id="wang-dropdown" class="multi-select-dropdown">
                                        <div class="multi-select-option">面色红润，精神可</div>
                                        <div class="multi-select-option">面色红润</div>
                                        <div class="multi-select-option">面色暗黄</div>
                                        <div class="multi-select-option">面色苍白</div>
                                        <div class="multi-select-option">面垢油光</div>
                                        <div class="multi-select-option">面色潮红</div>
                                        <div class="multi-select-option">形体正常</div>
                                        <div class="multi-select-option">形体肥胖</div>
                                        <div class="multi-select-option">形体消瘦</div>
                                        <div class="multi-select-option">疲倦</div>
                                        <div class="multi-select-option">周身困重</div>
                                        <div class="multi-select-option">情绪低沉</div>
                                        <div class="multi-select-option">精力充沛</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 舌 - 下拉多选框+输入框 -->
                            <div class="form-group">
                                <label for="she">舌:</label>
                                <div class="multi-select-container">
                                    <input type="text" id="she" class="multi-select-input" placeholder="请选择或输入...">
                                    <i class="fa fa-chevron-down select-arrow"></i>
                                    <div id="she-dropdown" class="multi-select-dropdown">
                                        <div class="multi-select-option">舌红</div>
                                        <div class="multi-select-option">舌淡红</div>
                                        <div class="multi-select-option">舌红绛</div>
                                        <div class="multi-select-option">舌暗红</div>
                                        <div class="multi-select-option">舌淡白</div>
                                        <div class="multi-select-option">舌胖，边有齿痕</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 苔 - 下拉多选框+输入框 -->
                            <div class="form-group">
                                <label for="tai">苔:</label>
                                <div class="multi-select-container">
                                    <input type="text" id="tai" class="multi-select-input" placeholder="请选择或输入...">
                                    <i class="fa fa-chevron-down select-arrow"></i>
                                    <div id="tai-dropdown" class="multi-select-dropdown">
                                        <div class="multi-select-option">苔白</div>
                                        <div class="multi-select-option">苔薄白</div>
                                        <div class="multi-select-option">少苔</div>
                                        <div class="multi-select-option">苔白腻</div>
                                        <div class="multi-select-option">苔黄腻</div>
                                        <div class="multi-select-option">苔燥</div>
                                        <div class="multi-select-option">腐苔</div>
                                        <div class="multi-select-option">剥落苔</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 闻 - 下拉多选框+输入框 -->
                            <div class="form-group">
                                <label for="wen">闻:</label>
                                <div class="multi-select-container">
                                    <input type="text" id="wen" class="multi-select-input" placeholder="请选择或输入...">
                                    <i class="fa fa-chevron-down select-arrow"></i>
                                    <div id="wen-dropdown" class="multi-select-dropdown">
                                        <div class="multi-select-option">语音正常</div>
                                        <div class="multi-select-option">声音低微</div>
                                        <div class="multi-select-option">声音轻浅</div>
                                        <div class="multi-select-option">声音洪亮</div>
                                        <div class="multi-select-option">体味汗味大</div>
                                        <div class="multi-select-option">口有异味</div>
                                        <div class="multi-select-option">无故叹气</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 问 - 下拉多选框+输入框 -->
                            <div class="form-group">
                                <label for="wen2">问:</label>
                                <div class="multi-select-container">
                                    <input type="text" id="wen2" class="multi-select-input" placeholder="请选择或输入...">
                                    <i class="fa fa-chevron-down select-arrow"></i>
                                    <div id="wen2-dropdown" class="multi-select-dropdown">
                                        <div class="multi-select-option">纳眠可，二便调</div>
                                        <div class="multi-select-option">胃口好</div>
                                        <div class="multi-select-option">胃口差</div>
                                        <div class="multi-select-option">睡眠好</div>
                                        <div class="multi-select-option">睡眠差</div>
                                        <div class="multi-select-option">二便正常</div>
                                        <div class="multi-select-option">大便干结</div>
                                        <div class="multi-select-option">大便溏</div>
                                        <div class="multi-select-option">畏寒怕冷</div>
                                        <div class="multi-select-option">畏热喜凉</div>
                                        <div class="multi-select-option">焦虑不安</div>
                                        <div class="multi-select-option">乏力</div>
                                        <div class="multi-select-option">出汗多</div>
                                        <div class="multi-select-option">口干</div>
                                        <div class="multi-select-option">口苦</div>
                                        <div class="multi-select-option">胸闷</div>
                                        <div class="multi-select-option">痰多</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 切 - 下拉多选框+输入框 -->
                            <div class="form-group">
                                <label for="qie">切:</label>
                                <div class="multi-select-container">
                                    <input type="text" id="qie" class="multi-select-input" placeholder="请选择或输入...">
                                    <i class="fa fa-chevron-down select-arrow"></i>
                                    <div id="qie-dropdown" class="multi-select-dropdown">
                                        <div class="multi-select-option">脉沉</div>
                                        <div class="multi-select-option">脉浮</div>
                                        <div class="multi-select-option">脉细</div>
                                        <div class="multi-select-option">脉数</div>
                                        <div class="multi-select-option">脉滑</div>
                                        <div class="multi-select-option">脉弦</div>
                                        <div class="multi-select-option">脉弱</div>
                                        <div class="multi-select-option">脉洪大</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
                
                <div class="main-content">
                    <form id="quizForm">
                        <!-- BMI计算区域 -->
                        <section class="bmi-calculator card">
                            <h2 class="section-title">
                                <i class="fa fa-calculator" aria-hidden="true"></i> 身体质量指数(BMI)计算
                            </h2>
                            
                            <div class="form-group">
                                <label for="height">身高(厘米):</label>
                                <input type="number" step="0.1" id="height" name="height" placeholder="请输入身高">
                                <span class="unit">cm</span>
                            </div>
                            
                            <div class="form-group">
                                <label for="weight">体重(千克):</label>
                                <input type="number" step="0.1" id="weight" name="weight" placeholder="请输入体重">
                                <span class="unit">kg</span>
                            </div>
                            
                            <div class="form-group">
                                <label for="waist">腰围(厘米):</label>
                                <input type="number" step="0.1" id="waist" name="waist" placeholder="请输入腰围">
                                <span class="unit">cm</span>
                            </div>
                            

                            
                            <div class="bmi-result">
                                <p>BMI指数: <span id="bmiValue">未计算</span></p>
                                <p>体型判断: <span id="bmiCategory"></span></p>
                            </div>
                            
                            <div class="bmi-standard">
                                <h3>BMI判断标准</h3>
                                <ul>
                                    <li>偏瘦: < 18.5</li>
                                    <li>正常: 18.5 - 23.9</li>
                                    <li>超重: 24.0 - 27.9</li>
                                    <li>肥胖: ≥ 28.0</li>
                                </ul>
                            </div>
                        </section>
                        
                        <!-- 问卷区域 -->
                        <section class="questions-section card">
                            <h2 class="section-title">
                                <i class="fa fa-list-alt" aria-hidden="true"></i> 体质辨识问卷
                            </h2>
                            
                            <p class="instructions">
                                请根据您的实际情况选择最符合的选项，这将帮助我们更准确地判断您的体质类型。
                                所有问题没有对错之分，请如实选择即可。
                            </p>
                            
                            <div class="questions-container" id="questionsContainer">
                                <!-- 问题将通过JavaScript动态生成 -->
                            </div>
                        </section>
                        
                        <!-- 按钮区域 -->
                        <div class="submit-section">
                            <div class="filename-group">
                                <label for="filename">居民姓名:</label>
                                <input type="text" id="filename" placeholder="请输入居民姓名">
                            </div>
                            
                            <!-- 查询界面已删除，移除返回按钮 -->
                            
                            <button type="button" id="resetBtn" class="btn btn-secondary">
                                <i class="fa fa-refresh" aria-hidden="true"></i> 重置
                            </button>
                            
                            <button type="button" id="submitBtn" class="btn">
                                <i class="fa fa-download" aria-hidden="true"></i> 下载结果
                            </button>
                            
                            <button type="button" id="saveToVikaBtn" class="btn" style="background-color: var(--accent-color);">
                                <i class="fa fa-save" aria-hidden="true"></i> 保存到维格表
                            </button>
                        </div>
                    </form>
                </div>
            </main>
            
            <!-- 体质判断规则和实时结果（固定位置） -->
            <aside>
                <div class="sidebar-wrapper">
                    <div class="constitution-rules">
                        <div>
                            <h2>
                                <i class="fa fa-book" aria-hidden="true"></i> 体质判断规则
                            </h2>
                            <ul>
                                <li>平和质：根据选项直接得分，最高25分</li>
                                <li>其他体质：≥11分为确定，9-10分为偏向</li>
                                <li>若其他体质≥11分则否定平和质</li>
                                <li>平和质≥18分为确定，16-17分为偏向</li>
                            </ul>
                        </div>
                        
                        <div>
                            <h2>
                                <i class="fa fa-link" aria-hidden="true"></i> 体质关联题目
                            </h2>
                            <div class="constitution-questions" id="constitutionQuestions">
                                <!-- 将通过JavaScript动态生成 -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="results-section">
                        <h2>
                            <i class="fa fa-bar-chart" aria-hidden="true"></i> 实时体质结果
                        </h2>
                        
                        <div class="result-table-container">
                            <table class="result-table">
                                <thead>
                                    <tr>
                                        <th>体质类型</th>
                                        <th>得分</th>
                                        <th>结果</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsTableBody">
                                    <!-- 将通过JavaScript动态生成 -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="summary" id="resultSummary">
                            请开始作答以查看结果
                        </div>
                    </div>
                </div>
            </aside>
        </div>
        
        <footer>
            <p>中医体质辨识工具 &copy; 2023 | 仅供健康参考，不替代专业医疗建议</p>
        </footer>
    </div>

    <script>
        // 初始化多选下拉框功能
        function initMultiSelects() {
            // 为每个四诊项目初始化多选功能
            const fields = ['wang', 'she', 'tai', 'wen', 'wen2', 'qie'];
            const allDropdowns = fields.map(field => document.getElementById(`${field}-dropdown`));
            
            fields.forEach(field => {
                const input = document.getElementById(field);
                const dropdown = document.getElementById(`${field}-dropdown`);
                const options = dropdown.querySelectorAll('.multi-select-option');
                const selectedValues = new Set();
                
                // 点击输入框显示/隐藏下拉框
                input.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    // 关闭所有其他下拉框
                    allDropdowns.forEach(d => {
                        if (d !== dropdown) {
                            d.classList.remove('active');
                        }
                    });
                    
                    // 切换当前下拉框状态
                    dropdown.classList.toggle('active');
                });
                
                // 点击选项选择/取消选择
                options.forEach(option => {
                    option.addEventListener('click', () => {
                        const value = option.textContent;
                        
                        if (selectedValues.has(value)) {
                            // 取消选择
                            selectedValues.delete(value);
                            option.classList.remove('selected');
                        } else {
                            // 选择
                            selectedValues.add(value);
                            option.classList.add('selected');
                        }
                        
                        // 更新输入框显示
                        input.value = Array.from(selectedValues).join(', ');
                        updateResults();
                    });
                });
                
                // 点击其他地方关闭下拉框
                document.addEventListener('click', () => {
                    dropdown.classList.remove('active');
                });
                
                // 阻止下拉框内部点击事件冒泡
                dropdown.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
                
                // 监听手动输入
                input.addEventListener('change', () => {
                    // 清空选择状态
                    selectedValues.clear();
                    options.forEach(option => option.classList.remove('selected'));
                    
                    // 解析手动输入的值
                    if (input.value.trim()) {
                        const values = input.value.split(',').map(v => v.trim());
                        values.forEach(value => {
                            selectedValues.add(value);
                            // 标记匹配的选项
                            options.forEach(option => {
                                if (option.textContent === value) {
                                    option.classList.add('selected');
                                }
                            });
                        });
                    }
                    updateResults();
                });
            });
        }

        // 问卷题目数据
        const questionsData = [
            {
                "id": 1,
                "text": "您精力充沛么吗？（指精神头足，乐于做事）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 2,
                "text": "您容易疲乏吗？（指体力如何，是否稍微活动一下或做一点家务劳动就感到累）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 3,
                "text": "您容易气短，呼吸短促，接不上气吗？",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 4,
                "text": "您说话声音低弱无力吗？（指说话没有力气）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 5,
                "text": "您感到闷闷不乐，情绪低沉吗？（指心情不愉快，情绪低落）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 6,
                "text": "您容易精神紧张，焦虑不安吗？（指遇事是否心情紧张）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 7,
                "text": "您因为生活状态改变而感到孤独、失落吗？",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 8,
                "text": "您容易感到害怕或受到惊吓吗？",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 9,
                "text": "您感到身体超重不轻松吗？（感觉身体沉重）[BMI指数＝体重（kg）/身高²（m）]",
                "options": ["BMI<24", "24≤BMI<25", "25≤BMI<26", "26≤BMI<28", "BMI≥28"]
            },
            {
                "id": 10,
                "text": "您眼睛干涩吗？",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 11,
                "text": "您手脚发凉吗？（不包含因周围温度低或穿的少导致的手脚发冷）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 12,
                "text": "您胃脘部、背部或腰膝部怕冷吗？（指上腹部、背部、腰部或膝关节等，有一处或多处怕冷）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 13,
                "text": "您比一般人耐受不了寒冷吗？（指比别人容易害怕冬天或是夏天的冷空调，电扇等）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 14,
                "text": "您容易患感冒吗？（指每年感冒的次数）",
                "options": ["一年<2次", "一年感冒2－4次", "一年感冒5－6次", "一年感冒8次以上", "几乎每月都感冒"]
            },
            {
                "id": 15,
                "text": "您没有感冒时也会鼻塞、流鼻涕吗？",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 16,
                "text": "您有口粘口腻，或睡眠打鼾吗？",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 17,
                "text": "您容易过敏(对药物、食物、气味、花粉或在季节交替、气候变化时)吗?",
                "options": ["从来没有", "一年1、2次", "一年3、4次", "一年5、6次", "每次遇到上述原因都过敏"]
            },
            {
                "id": 18,
                "text": "您的皮肤容易起荨麻疹吗? (包括风团、风疹块、风疙瘩)",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 19,
                "text": "您的皮肤在不知不觉中会出现青紫瘀斑、皮下出血吗?（指皮肤在没有外伤的情况下出现青一块紫一块的情况）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 20,
                "text": "您的皮肤一抓就红，并出现抓痕吗?（指被指甲或钝物划过后皮肤的反应）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 21,
                "text": "您皮肤或口唇干吗?",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 22,
                "text": "您有肢体麻木或固定部位疼痛的感觉吗？",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 23,
                "text": "您面部或鼻部有油腻感或者油亮发光吗?（指脸上或鼻子）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 24,
                "text": "您面色或目眶晦黯，或出现褐色斑块/斑点吗?",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 25,
                "text": "您有皮肤湿疹、疮疖吗？",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 26,
                "text": "您感到口干咽燥、总想喝水吗？",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 27,
                "text": "您感到口苦或嘴里有异味吗?（指口苦或口臭）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 28,
                "text": "您腹部肥大吗?（指腹部脂肪肥厚）",
                "options": ["腹围<80cm,相当于2.4尺", "腹围80-85cm,2.4-2.55尺", "腹围86-90cm,2.56-2.7尺", "腹围91-105cm,2.71-3.15尺", "腹围>105cm或3.15尺"]
            },
            {
                "id": 29,
                "text": "您吃(喝)凉的东西会感到不舒服或者怕吃(喝)凉的东西吗？（指不喜欢吃凉的食物，或吃了凉的食物后会不舒服）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 30,
                "text": "您有大便黏滞不爽、解不尽的感觉吗?(大便容易粘在马桶或便坑壁上)",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 31,
                "text": "您容易大便干燥吗?",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 32,
                "text": "您舌苔厚腻或有舌苔厚厚的感觉吗?（如果自我感觉不清楚可由调查员观察后填写）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            },
            {
                "id": 33,
                "text": "您舌下静脉瘀紫或增粗吗？（可由调查员辅助观察后填写）",
                "options": ["没有", "很少", "有时", "经常", "总是"]
            }
        ];

        // 定义体质与关联题目
        const constitutionQuestions = {
            "阳虚质": [11, 12, 13, 29],
            "阴虚质": [10, 21, 26, 31],
            "气虚质": [2, 3, 4, 14],
            "痰湿质": [9, 16, 28, 32],
            "湿热质": [23, 25, 27, 30],
            "血瘀质": [19, 22, 24, 33],
            "特禀质": [15, 17, 18, 20],
            "气郁质": [5, 6, 7, 8],
            "平和质": [1, 2, 4, 5, 13]
        };

        // 其他体质计分规则
        const optionScores = {
            "没有": 1,
            "很少": 2,
            "有时": 3,
            "经常": 4,
            "总是": 5,
            "一年<2次": 1,
            "一年感冒2－4次": 2,
            "一年感冒5－6次": 3,
            "一年感冒8次以上": 4,
            "几乎每月都感冒": 5,
            "从来没有": 1,
            "一年1、2次": 2,
            "一年3、4次": 3,
            "一年5、6次": 4,
            "每次遇到上述原因都过敏": 5,
            "BMI<24": 1,
            "24≤BMI<25": 2,
            "25≤BMI<26": 3,
            "26≤BMI<28": 4,
            "BMI≥28": 5,
            "腹围<80cm,相当于2.4尺": 1,
            "腹围80-85cm,2.4-2.55尺": 2,
            "腹围86-90cm,2.56-2.7尺": 3,
            "腹围91-105cm,2.71-3.15尺": 4,
            "腹围>105cm或3.15尺": 5
        };

        // 特殊题目ID（有特殊选项的题目）
        const specialQuestionIds = new Set([9, 14, 17, 28]);

        // 平和质特殊计分规则
        const pingheScoring = {
            1: {"没有": 1, "很少": 2, "有时": 3, "经常": 4, "总是": 5},
            2: {"没有": 5, "很少": 4, "有时": 3, "经常": 2, "总是": 1},
            4: {"没有": 5, "很少": 4, "有时": 3, "经常": 2, "总是": 1},
            5: {"没有": 5, "很少": 4, "有时": 3, "经常": 2, "总是": 1},
            13: {"没有": 5, "很少": 4, "有时": 3, "经常": 2, "总是": 1}
        };

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化多选下拉框
            initMultiSelects();
            
            // 设置默认文件名（包含当前日期时间）
            setDefaultFilename();
            
            // 生成体质关联题目列表
            generateConstitutionQuestionsList();
            
            // 生成问卷题目
            generateQuestions();
            
            // 绑定事件处理函数
            bindEvents();
            
            // 初始化结果表格
            updateResults();
        });

        // 设置默认文件名
        function setDefaultFilename() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            const defaultFilename = `体质辨识结果_${year}${month}${day}_${hours}${minutes}${seconds}`;
            document.getElementById('filename').value = defaultFilename;
        }

        // 生成体质关联题目列表
        function generateConstitutionQuestionsList() {
            const container = document.getElementById('constitutionQuestions');
            container.innerHTML = '';
            
            for (const [constitution, qIds] of Object.entries(constitutionQuestions)) {
                const div = document.createElement('div');
                div.className = 'constitution-item';
                
                // 将题目ID转换为可点击链接
                const linkedQIds = qIds.map(qId => {
                    return `<a href="#question-${qId}" class="question-link" title="跳转到问题${qId}">${qId}</a>`;
                }).join(', ');
                
                div.innerHTML = `<strong>${constitution}:</strong> ${linkedQIds}`;
                container.appendChild(div);
            }
        }

        // 生成问卷题目
        function generateQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            
            // 按ID排序问题
            const sortedQuestions = [...questionsData].sort((a, b) => a.id - b.id);
            
            sortedQuestions.forEach(question => {
                // 找到关联的体质类型
                const relatedConstitutions = [];
                for (const [constitution, qIds] of Object.entries(constitutionQuestions)) {
                    if (qIds.includes(question.id)) {
                        relatedConstitutions.push(constitution);
                    }
                }
                
                // 创建问题容器
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-item';
                questionDiv.dataset.id = question.id;
                questionDiv.id = `question-${question.id}`; // 添加唯一ID，用于跳转
                
                // 问题头部（包含ID和关联体质）
                let headerHtml = `<div class="question-header">
                    <h3>问题 ${question.id}</h3>`;
                
                if (relatedConstitutions.length > 0) {
                    headerHtml += `<div class="related-constitutions">
                        关联体质: ${relatedConstitutions.join(', ')}
                    </div>`;
                }
                
                headerHtml += `</div>`;
                
                // 问题文本
                headerHtml += `<div class="question-text">${question.text}</div>`;
                
                // 选项（横向排列）
                headerHtml += `<div class="question-options">`;
                
                question.options.forEach((option, index) => {
                    // 对于问题1，默认选中"总是"选项（index=4），其他问题保持默认选中第一个选项
                    const isChecked = (question.id === 1 && index === 4) || (question.id !== 1 && index === 0);
                    headerHtml += `
                        <div class="option-item">
                            <input type="radio" name="q${question.id}" 
                                   id="q${question.id}-${index}" 
                                   value="${option}" 
                                   ${isChecked ? 'checked' : ''}>
                            <label for="q${question.id}-${index}">${option}</label>
                        </div>
                    `;
                });
                
                headerHtml += `</div>`;
                
                questionDiv.innerHTML = headerHtml;
                container.appendChild(questionDiv);
            });
        }

        // 维格表API配置
        const API_TOKEN = 'usked7s28OyhurRwWG5mXyW';
        const TABLE_ID = 'dstPpHeiMjd9riVC1a';
        const BASE_URL = 'https://api.vika.cn/fusion/v1/datasheets';
        
        // 从URL获取参数
        function getUrlParams() {
            const params = {};
            const url = new URL(window.location.href);
            url.searchParams.forEach((value, key) => {
                params[key] = value;
            });
            return params;
        }
        
        // 绑定事件处理函数
        function bindEvents() {
            // 身高体重输入变化时实时计算BMI
            document.getElementById('height').addEventListener('input', calculateBMI);
            document.getElementById('weight').addEventListener('input', calculateBMI);
            
            // 腰围输入变化时自动选择腰围范围
            document.getElementById('waist').addEventListener('input', autoSelectWaistRange);
            
            // 重置按钮
            document.getElementById('resetBtn').addEventListener('click', resetForm);
            
            // 提交按钮
            document.getElementById('submitBtn').addEventListener('click', downloadResults);
            
            // 保存到维格表按钮
            document.getElementById('saveToVikaBtn').addEventListener('click', saveToVika);
            
            // 回车键计算BMI
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && 
                    (document.activeElement === document.getElementById('height') || 
                     document.activeElement === document.getElementById('weight') || 
                     document.activeElement === document.getElementById('waist'))) {
                    calculateBMI();
                    autoSelectWaistRange();
                }
            });
            
            // 所有单选按钮变化时更新结果
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', updateResults);
            });
        }

        // 计算BMI
        function calculateBMI() {
            const heightInput = document.getElementById('height');
            const weightInput = document.getElementById('weight');
            const bmiValue = document.getElementById('bmiValue');
            const bmiCategory = document.getElementById('bmiCategory');
            
            try {
                const height = parseFloat(heightInput.value);
                const weight = parseFloat(weightInput.value);
                
                // 输入不完整或无效时，清除BMI显示
                if (isNaN(height) || isNaN(weight) || height <= 0 || weight <= 0) {
                    bmiValue.textContent = '0.0';
                    bmiCategory.textContent = '未计算';
                    bmiCategory.className = '';
                    return;
                }
                
                const heightM = height / 100;
                const bmi = weight / (heightM * heightM);
                bmiValue.textContent = bmi.toFixed(1);
                
                // 设置BMI分类和样式
                if (bmi < 18.5) {
                    bmiCategory.textContent = "偏瘦";
                    bmiCategory.className = "underweight";
                } else if (bmi < 24) {
                    bmiCategory.textContent = "正常";
                    bmiCategory.className = "normal";
                } else if (bmi < 28) {
                    bmiCategory.textContent = "超重";
                    bmiCategory.className = "overweight";
                } else {
                    bmiCategory.textContent = "肥胖";
                    bmiCategory.className = "obese";
                }
                
                // 自动选择问题9的BMI范围
                let bmiOption = "BMI<24";
                if (bmi >= 24 && bmi < 25) {
                    bmiOption = "24≤BMI<25";
                } else if (bmi >= 25 && bmi < 26) {
                    bmiOption = "25≤BMI<26";
                } else if (bmi >= 26 && bmi < 28) {
                    bmiOption = "26≤BMI<28";
                } else if (bmi >= 28) {
                    bmiOption = "BMI≥28";
                }
                
                // 找到问题9的对应选项并选中
                const q9Radio = document.querySelector(`input[name="q9"][value="${bmiOption}"]`);
                if (q9Radio) {
                    q9Radio.checked = true;
                }
                
                // 同时更新腰围范围
                autoSelectWaistRange();
                
                // 更新结果
                updateResults();
            } catch (error) {
                alert('计算BMI时出错: ' + error.message);
            }
        }
        
        // 自动选择问题28的腰围范围
        function autoSelectWaistRange() {
            const waistInput = document.getElementById('waist');
            
            try {
                const waist = parseFloat(waistInput.value);
                
                if (isNaN(waist) || waist <= 0) {
                    return; // 腰围无效，不进行选择
                }
                
                // 自动选择问题28的腰围范围
                let waistOption = "腹围<80cm,相当于2.4尺";
                if (waist >= 80 && waist <= 85) {
                    waistOption = "腹围80-85cm,2.4-2.55尺";
                } else if (waist > 85 && waist <= 90) {
                    waistOption = "腹围86-90cm,2.56-2.7尺";
                } else if (waist > 90 && waist <= 105) {
                    waistOption = "腹围91-105cm,2.71-3.15尺";
                } else if (waist > 105) {
                    waistOption = "腹围>105cm或3.15尺";
                }
                
                // 找到问题28的对应选项并选中
                const q28Radio = document.querySelector(`input[name="q28"][value="${waistOption}"]`);
                if (q28Radio) {
                    q28Radio.checked = true;
                    updateResults(); // 更新结果
                }
            } catch (error) {
                alert('选择腰围范围时出错: ' + error.message);
            }
        }

        // 重置表单
        function resetForm() {
            // 重置四诊信息
            const fields = ['wang', 'she', 'tai', 'wen', 'wen2', 'qie'];
            fields.forEach(field => {
                const input = document.getElementById(field);
                const dropdown = document.getElementById(`${field}-dropdown`);
                const options = dropdown.querySelectorAll('.multi-select-option');
                
                input.value = '';
                options.forEach(option => option.classList.remove('selected'));
            });
            
            // 重置BMI输入
            document.getElementById('height').value = '';
            document.getElementById('weight').value = '';
            document.getElementById('waist').value = '';
            document.getElementById('bmiValue').textContent = '未计算';
            document.getElementById('bmiCategory').textContent = '';
            document.getElementById('bmiCategory').className = '';
            
            // 重置所有单选按钮
            document.querySelectorAll('.question-item').forEach(question => {
                const radios = question.querySelectorAll('input[type="radio"]');
                if (radios.length > 0) {
                    // 对于问题1，重置为"总是"选项（index=4），其他问题重置为第一个选项
                    const questionId = parseInt(question.dataset.id);
                    if (questionId === 1 && radios.length > 4) {
                        radios[4].checked = true;
                    } else {
                        radios[0].checked = true;
                    }
                }
            });
            
            // 重置文件名
            setDefaultFilename();
            
            // 更新结果
            updateResults();
        }

        // 获取所有答案
        function getAnswers() {
            const answers = {};
            
            document.querySelectorAll('.question-item').forEach(question => {
                const qId = question.dataset.id;
                const selectedOption = question.querySelector(`input[name="q${qId}"]:checked`);
                
                if (selectedOption) {
                    answers[qId] = selectedOption.value;
                }
            });
            
            return answers;
        }

        // 获取四诊信息
        function getDiagnosisInfo() {
            return {
                "望": document.getElementById('wang').value || '未填写',
                "舌": document.getElementById('she').value || '未填写',
                "苔": document.getElementById('tai').value || '未填写',
                "闻": document.getElementById('wen').value || '未填写',
                "问": document.getElementById('wen2').value || '未填写',
                "切": document.getElementById('qie').value || '未填写'
            };
        }

        // 计算体质得分
        function calculateConstitutionScores(answers) {
            const scores = {};
            // 初始化所有体质得分为0
            Object.keys(constitutionQuestions).forEach(constitution => {
                scores[constitution] = 0;
            });
            
            // 计算每个体质的得分
            for (const [constitution, questionIds] of Object.entries(constitutionQuestions)) {
                if (constitution === "平和质") {
                    // 平和质使用特殊计分规则
                    let pingheTotal = 0;
                    questionIds.forEach(qId => {
                        const answer = answers[qId] || "";
                        if (pingheScoring[qId] && pingheScoring[qId][answer]) {
                            pingheTotal += pingheScoring[qId][answer];
                        } else if (specialQuestionIds.has(Number(qId))) {
                            // 特殊题目计分
                            const question = questionsData.find(q => q.id === Number(qId));
                            if (question && question.options.includes(answer)) {
                                pingheTotal += question.options.indexOf(answer) + 1;
                            }
                        }
                    });
                    scores[constitution] = pingheTotal;
                } else {
                    // 其他体质使用标准计分规则
                    let totalScore = 0;
                    questionIds.forEach(qId => {
                        const answer = answers[qId] || "";
                        if (specialQuestionIds.has(Number(qId))) {
                            // 特殊题目计分
                            const question = questionsData.find(q => q.id === Number(qId));
                            if (question && question.options.includes(answer)) {
                                totalScore += question.options.indexOf(answer) + 1;
                            }
                        } else {
                            totalScore += optionScores[answer] || 0;
                        }
                    });
                    scores[constitution] = totalScore;
                }
            }
            
            return scores;
        }

        // 判断体质类型
        function determineConstitutionTypes(scores) {
            const results = {};
            let otherConstitutionsHigh = false; // 是否有其他体质≥11分
            
            // 先判断非平和质的体质类型
            Object.entries(scores).forEach(([constitution, score]) => {
                if (constitution !== "平和质") {
                    if (score >= 11) {
                        results[constitution] = "确定";
                        otherConstitutionsHigh = true;
                    } else if (score >= 9 && score <= 10) {
                        results[constitution] = "偏向";
                    } else {
                        results[constitution] = "否定";
                    }
                }
            });
            
            // 判断平和质
            if (otherConstitutionsHigh) {
                results["平和质"] = "否定";
            } else {
                const pingheScore = scores["平和质"];
                if (pingheScore >= 18) {
                    results["平和质"] = "确定";
                } else if (pingheScore >= 16 && pingheScore <= 17) {
                    results["平和质"] = "偏向";
                } else {
                    results["平和质"] = "否定";
                }
            }
            
            return results;
        }

        // 更新结果显示
        function updateResults() {
            const answers = getAnswers();
            const scores = calculateConstitutionScores(answers);
            const results = determineConstitutionTypes(scores);
            
            // 更新结果表格
            updateResultsTable(scores, results);
            
            // 更新结果总结
            updateResultSummary(scores, results);
        }

        // 更新结果表格
        function updateResultsTable(scores, results) {
            const tableBody = document.getElementById('resultsTableBody');
            tableBody.innerHTML = '';
            
            // 按得分排序
            const sortedConstitutions = Object.keys(scores).sort((a, b) => scores[b] - scores[a]);
            
            sortedConstitutions.forEach(constitution => {
                const row = document.createElement('tr');
                
                // 根据结果设置不同的颜色
                let resultClass = '';
                if (results[constitution] === "确定") {
                    resultClass = 'style="color: var(--success-color); font-weight: bold"';
                } else if (results[constitution] === "偏向") {
                    resultClass = 'style="color: var(--warning-color)"';
                }
                
                row.innerHTML = `
                    <td>${constitution}</td>
                    <td>${scores[constitution]}</td>
                    <td ${resultClass}>${results[constitution]}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // 更新结果总结
        function updateResultSummary(scores, results) {
            const summaryElement = document.getElementById('resultSummary');
            
            // 分离确定和偏向的体质
            const definiteConstitutions = [];
            const leaningConstitutions = [];
            
            Object.entries(results).forEach(([constitution, result]) => {
                if (result === "确定") {
                    definiteConstitutions.push(constitution);
                } else if (result === "偏向") {
                    leaningConstitutions.push(constitution);
                }
            });
            
            // 构建总结文本
            const summaryParts = [];
            
            if (definiteConstitutions.length > 0) {
                summaryParts.push(`确定的体质类型: ${definiteConstitutions.join(', ')}`);
            }
            
            if (leaningConstitutions.length > 0) {
                summaryParts.push(`偏向的体质类型: ${leaningConstitutions.join(', ')}`);
            }
            
            // 添加BMI信息
            const bmiValue = document.getElementById('bmiValue').textContent;
            const bmiCategory = document.getElementById('bmiCategory').textContent;
            if (bmiValue !== '未计算' && bmiCategory) {
                summaryParts.push(`BMI指数: ${bmiValue} (${bmiCategory})`);
            }
            
            // 设置总结文本
            if (summaryParts.length === 0) {
                summaryElement.textContent = "未能确定明显的体质类型";
            } else {
                summaryElement.innerHTML = summaryParts.join('<br>');
            }
        }

        // 下载结果为Excel
        function downloadResults() {
            try {
                // 获取用户输入的文件名
                let filename = document.getElementById('filename').value.trim();
                
                // 验证文件名
                if (!filename) {
                    alert('请输入文件名');
                    return;
                }
                
                // 移除可能的文件扩展名（会自动添加.xlsx）
                filename = filename.replace(/\.(xlsx|xls)$/i, '');
                
                // 获取答案和计算结果
                const answers = getAnswers();
                const scores = calculateConstitutionScores(answers);
                const results = determineConstitutionTypes(scores);
                
                // 获取四诊信息
                const diagnosisInfo = getDiagnosisInfo();
                
                // 执行验证规则
                const validationErrors = [];
                
                // 规则1: 检测身高、体重、腰围是否都已输入
                const height = document.getElementById('height').value.trim();
                const weight = document.getElementById('weight').value.trim();
                const waist = document.getElementById('waist').value.trim();
                if (!height || !weight || !waist) {
                    validationErrors.push('请先输入身高、体重和腰围信息');
                }
                
                // 规则2: 检测问题1和问题2的冲突
                const question1Answer = answers['1'] || '';
                const question2Answer = answers['2'] || '';
                if (question1Answer.includes('没有') && question2Answer.includes('没有')) {
                    validationErrors.push('问题1的精力充沛么和问题2的容易疲乏冲突');
                }
                
                // 规则3: 检测问题32与苔信息的匹配
                const question32Answer = answers['32'] || '';
                const taiInfo = diagnosisInfo['苔'] || '';
                const question32InvalidAnswers = ['有时', '经常', '总是'];
                const taiKeywords = ['苔白腻', '苔黄腻', '苔腻', '腻'];
                
                if (question32InvalidAnswers.some(answer => question32Answer.includes(answer))) {
                    const hasTaiKeyword = taiKeywords.some(keyword => taiInfo.includes(keyword));
                    if (!hasTaiKeyword) {
                        validationErrors.push('勾选了舌苔厚腻，但"苔"未填写白腻、黄腻、腻等关键字');
                    }
                }
                
                // 规则3: 检测阴虚质和阳虚质的冲突
                const hasYinxu = results['阴虚质'] === '确定' || results['阴虚质'] === '偏向';
                const hasYangxu = results['阳虚质'] === '确定' || results['阳虚质'] === '偏向';
                if (hasYinxu && hasYangxu) {
                    validationErrors.push('检测出阴虚质和阳虚质，体质冲突');
                }
                
                // 如果有验证错误，显示汇总消息框
                if (validationErrors.length > 0) {
                    alert(validationErrors.join('\n'));
                    return;
                }
                
                // 获取BMI数据
                const bmiData = {
                    height: document.getElementById('height').value || '未填写',
                    weight: document.getElementById('weight').value || '未填写',
                    waist: document.getElementById('waist').value || '未填写',
                    bmi: document.getElementById('bmiValue').textContent,
                    category: document.getElementById('bmiCategory').textContent || '未计算'
                };
                
                // 创建工作簿
                const wb = XLSX.utils.book_new();
                
                // 1. 创建个人信息工作表
                const personalData = [
                    ["信息项", "数值"],
                    ["提交时间", new Date().toLocaleString()],
                    ["身高(cm)", bmiData.height],
                    ["体重(kg)", bmiData.weight],
                    ["腰围(cm)", bmiData.waist],
                    ["BMI指数", bmiData.bmi],
                    ["体型判断", bmiData.category],
                    ["", ""], // 空行分隔
                    ["中医四诊信息", ""],
                    ["望", diagnosisInfo["望"]],
                    ["舌", diagnosisInfo["舌"]],
                    ["苔", diagnosisInfo["苔"]],
                    ["闻", diagnosisInfo["闻"]],
                    ["问", diagnosisInfo["问"]],
                    ["切", diagnosisInfo["切"]]
                ];
                const personalWs = XLSX.utils.aoa_to_sheet(personalData);
                XLSX.utils.book_append_sheet(wb, personalWs, "个人信息");
                
                // 2. 创建问卷答案工作表
                const answersData = [["问题ID", "问题内容", "选择答案", "得分", "关联体质"]];
                
                questionsData.forEach(question => {
                    const qId = question.id;
                    const answer = answers[qId] || "";
                    
                    // 计算得分
                    let score = 0;
                    let scoreNote = "";
                    
                    if (specialQuestionIds.has(qId)) {
                        if (question.options.includes(answer)) {
                            score = question.options.indexOf(answer) + 1;
                            scoreNote = score.toString();
                        }
                    } else {
                        score = optionScores[answer] || 0;
                        scoreNote = score.toString();
                    }
                    
                    // 检查是否是平和质的特殊计分题目
                    if (pingheScoring[qId] && pingheScoring[qId][answer]) {
                        const pingheScore = pingheScoring[qId][answer];
                        scoreNote = `标准分:${score}, 平和质得分:${pingheScore}`;
                    }
                    
                    // 获取关联体质
                    const relatedConstitutions = [];
                    Object.entries(constitutionQuestions).forEach(([constitution, qIds]) => {
                        if (qIds.includes(qId)) {
                            relatedConstitutions.push(constitution);
                        }
                    });
                    
                    answersData.push([
                        qId,
                        question.text,
                        answer,
                        scoreNote,
                        relatedConstitutions.join(', ')
                    ]);
                });
                
                const answersWs = XLSX.utils.aoa_to_sheet(answersData);
                XLSX.utils.book_append_sheet(wb, answersWs, "问卷答案");
                
                // 3. 创建体质辨识结果工作表
                const resultsData = [["体质类型", "得分", "判断结果", "关联题目"]];
                
                Object.entries(results).forEach(([constitution, result]) => {
                    const relatedQuestions = constitutionQuestions[constitution].join(', ');
                    resultsData.push([
                        constitution,
                        scores[constitution],
                        result,
                        relatedQuestions
                    ]);
                });
                
                // 添加体质总结
                resultsData.push([]);
                resultsData.push([]);
                const definiteConstitutions = Object.entries(results)
                    .filter(([_, result]) => result === "确定")
                    .map(([constitution, _]) => constitution);
                
                const leaningConstitutions = Object.entries(results)
                    .filter(([_, result]) => result === "偏向")
                    .map(([constitution, _]) => constitution);
                
                if (definiteConstitutions.length > 0) {
                    resultsData.push(["主要体质类型:", definiteConstitutions.join(', ')]);
                }
                
                if (leaningConstitutions.length > 0) {
                    resultsData.push(["偏向体质类型:", leaningConstitutions.join(', ')]);
                }
                
                const resultsWs = XLSX.utils.aoa_to_sheet(resultsData);
                XLSX.utils.book_append_sheet(wb, resultsWs, "体质结果");
                
                // 生成并下载Excel文件
                XLSX.writeFile(wb, `${filename}.xlsx`);
                
                // 显示成功提示
                alert('体质辨识结果已成功导出为Excel文件！');
            } catch (error) {
                console.error('导出Excel失败:', error);
                alert('导出Excel时发生错误: ' + error.message);
            }
        }
    
    // 保存结果到维格表，只实现新增数据功能
    function saveToVika() {
        try {
            // 获取当前居民姓名
            const name = document.getElementById('filename').value.trim() || '未命名';
            
            // 获取身高、体重、腰围
            const height = document.getElementById('height').value.trim();
            const weight = document.getElementById('weight').value.trim();
            const waist = document.getElementById('waist').value.trim();
            
            // 验证身高、体重、腰围为必填项
            if (!height) {
                alert('请填写身高信息');
                return;
            }
            if (!weight) {
                alert('请填写体重信息');
                return;
            }
            if (!waist) {
                alert('请填写腰围信息');
                return;
            }
            
            // 获取四诊信息
            const diagnosisInfo = getDiagnosisInfo();
            
            // 体检日期默认为当天日期
            const examDate = new Date().toISOString().split('T')[0];
            
            // 构建基础字段
            const fields = {
                '姓名': name,
                '体检日期': examDate,
                '身高': height ? height.toString() : '',
                '体重': weight ? weight.toString() : '',
                '腰围': waist ? waist.toString() : '',
                '望': diagnosisInfo["望"],
                '舌': diagnosisInfo["舌"],
                '苔': diagnosisInfo["苔"],
                '闻': diagnosisInfo["闻"],
                '问': diagnosisInfo["问"],
                '切': diagnosisInfo["切"]
            };
            
            // 添加所有问题的选项到fields中
            document.querySelectorAll('.question-item').forEach(question => {
                const qId = question.dataset.id;
                const questionText = question.querySelector('.question-text').textContent.trim();
                const selectedOption = question.querySelector(`input[name="q${qId}"]:checked`);
                
                if (selectedOption) {
                    const label = question.querySelector(`label[for="${selectedOption.id}"]`);
                    if (label) {
                        // 使用问题文本作为字段名，选项文本作为值
                        fields[questionText] = label.textContent.trim();
                    }
                } else {
                    // 没有选中选项时，设置为空字符串
                    fields[questionText] = '';
                }
            });
            
            // 单独处理问题9，确保它能正确保存到维格表
            const question9 = document.querySelector('.question-item[data-id="9"]');
            if (question9) {
                const question9Text = '您感到身体超重不轻松吗？（感觉身体沉重）[BMI指数＝体重（kg）/身高2（m）]';
                let question9Answer = '';
                
                // 使用直接的CSS选择器获取选中选项
                for (let i = 0; i < 5; i++) {
                    const radio = document.querySelector(`#q9-${i}:checked`);
                    if (radio) {
                        const label = document.querySelector(`label[for="${radio.id}"]`);
                        if (label) {
                            question9Answer = label.textContent.trim();
                            break;
                        }
                    }
                }
                
                // 将问题9的答案添加到fields中，覆盖之前可能没有正确保存的值
                fields[question9Text] = question9Answer;
            }
            
            // 构建新增记录的请求体
            const requestBody = {
                records: [
                    {
                        fields: fields
                    }
                ]
            };
            
            console.log('最终发送的数据:', requestBody);
            
            // 检查当前页面是否通过HTTP服务器访问
            if (window.location.protocol === 'file:') {
                alert('保存到维格表失败: 由于浏览器安全限制，直接打开HTML文件无法访问网络资源。请通过HTTP/HTTPS服务器访问页面，例如：GitHub Pages、Netlify或本地服务器。');
                return;
            }
            
            // 发送新增记录请求
            fetch(`${BASE_URL}/${TABLE_ID}/records`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${API_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody),
                mode: 'cors' // 明确指定CORS模式
            })
            .then(response => {
                console.log('保存响应状态:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('保存响应数据:', data);
                if (data.success) {
                    alert('体质辨识结果已成功保存到维格表！');
                    // 保存成功后自动重置所有内容
                    resetForm();
                } else {
                    alert('保存到维格表失败: ' + (data.message || '未知错误'));
                }
            })
            .catch(error => {
                console.error('保存到维格表出错:', error);
                
                // 根据错误类型提供更详细的提示
                if (error.name === 'TypeError') {
                    if (error.message.includes('CORS')) {
                        alert('保存到维格表失败: 跨域资源共享(CORS)错误。请使用HTTP服务器访问页面，或检查浏览器安全设置。');
                    } else if (error.message.includes('Failed to fetch')) {
                        alert('保存到维格表失败: 网络连接错误。请检查网络连接，确保能够访问https://api.vika.cn，或稍后重试。');
                    } else {
                        alert('保存到维格表失败: 网络错误。请检查网络连接后重试。\n错误详情: ' + error.message);
                    }
                } else {
                    alert('保存到维格表失败: ' + error.message);
                }
            });
        } catch (error) {
            console.error('保存到维格表失败:', error);
            alert('保存到维格表时发生错误: ' + error.message);
        }
    }
    
    // 查询界面已删除，移除相关功能代码
    </script>
</body>
</html>
